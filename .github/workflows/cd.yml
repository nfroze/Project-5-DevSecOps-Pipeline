name: Deploy & Runtime Security

on:
  workflow_run:
    workflows: ["Container Build & Scan"]
    types:
      - completed

jobs:
  deploy-and-verify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üîß Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2

      - name: üîå Connect to EKS
        run: |
          aws eks update-kubeconfig --region eu-west-2 --name project5-eks-cluster
          echo "‚úÖ Connected to EKS cluster"

      - name: üöÄ Deploy to Kubernetes
        run: |
          # Create namespace
          kubectl apply -f k8s/namespace.yaml
          
          # Deploy application
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          
          # Update image to latest build
          kubectl set image deployment/project5-deployment \
            project5-app=nfroze/project5-app:${{ github.sha }} \
            -n project5
          
          # Wait for rollout
          kubectl rollout status deployment/project5-deployment -n project5 --timeout=300s
          echo "‚úÖ Application deployed successfully"

      - name: üåê Get Application URL
        id: get-url
        run: |
          echo "Waiting for LoadBalancer..."
          for i in {1..30}; do
            LB_URL=$(kubectl get svc project5-service -n project5 -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
            if [ -n "$LB_URL" ]; then
              echo "APP_URL=http://${LB_URL}" >> $GITHUB_ENV
              echo "url=http://${LB_URL}" >> $GITHUB_OUTPUT
              echo "‚úÖ Application accessible at: http://${LB_URL}"
              break
            fi
            sleep 10
          done

      - name: ü©∫ Health Check
        run: |
          echo "Verifying application health..."
          for i in {1..10}; do
            if curl -f "${{ env.APP_URL }}/health" >/dev/null 2>&1; then
              echo "‚úÖ Application is healthy"
              break
            fi
            echo "Waiting for app to be ready... (attempt $i/10)"
            sleep 5
          done

      - name: üõ°Ô∏è DAST Security Scan (OWASP ZAP)
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: ${{ steps.get-url.outputs.url }}
          cmd_options: '-I'
          allow_issue_writing: false

      - name: ‚úÖ Deployment Summary
        if: always()
        run: |
          echo "### Deployment Complete! üéâ"
          echo "- **Application URL**: ${{ env.APP_URL }}"
          echo "- **Container Image**: nfroze/project5-app:${{ github.sha }}"
          echo "- **Security Scans**: Completed"
          echo ""
          echo "AWS GuardDuty and CloudWatch are now monitoring this deployment."