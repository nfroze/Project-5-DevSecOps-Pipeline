name: 🚀 CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write
  issues: write  # Needed only if allow_issue_writing is true (disabled below)

jobs:
  deploy:
    name: 🚀 Deploy to EKS
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      - name: ☁️ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<your-account-id>:role/<your-deploy-role>
          aws-region: eu-west-2

      - name: ☸️ Update kubeconfig
        run: aws eks update-kubeconfig --region eu-west-2 --name project5-eks

      - name: 📦 Deploy to EKS
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

  zap_scan:
    name: 🧪 ZAP Full Scan
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      - name: 🧪 Run ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: 'http://a1fc376fb666a42afa11820972d153a1-528790283.eu-west-2.elb.amazonaws.com/'
          fail_action: false  # Don't fail pipeline even if warnings exist
          allow_issue_writing: false  # Disable GitHub Issue creation

      - name: 📤 Upload ZAP HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-html
          path: report_html.html

      - name: 📤 Upload ZAP JSON Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-json
          path: report_json.json