name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install dependencies
      run: npm install

    - name: Install Semgrep
      run: |
        pip install semgrep

    - name: Run Semgrep (SAST)
      run: |
        semgrep --config=auto --json --output=semgrep-report.json

    - name: Run Trivy (SCA + image scan)
      run: |
        trivy fs . --format json --output trivy-report.json

    - name: Run Gitleaks (Secrets detection)
      run: |
        gitleaks detect --source=. --report-format=json --report-path=gitleaks-report.json

    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      with:
        name: scan-reports
        path: |
          semgrep-report.json
          trivy-report.json
          gitleaks-report.json