name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v3

      - name: 🛠 Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Trivy
        run: |
          sudo apt-get update && sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.41.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.41.2_Linux-64bit.deb

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🧠 Run Semgrep (SAST)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/src" \
            returntocorp/semgrep-agent \
            semgrep --config "p/default"

      - name: 🕵️‍♂️ Run Gitleaks (Secrets Scan)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: "--source=. --report-path=gitleaks-report.json --report-format=json"

      - name: 🧪 Trivy FS scan (SCA)
        run: |
          trivy fs . --format json --output trivy-fs-results.json

      - name: 🐳 Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-app:${{ github.sha }} .

      - name: 🔍 Trivy Image Scan
        run: |
          trivy image --format json --output trivy-image-results.json ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-app:${{ github.sha }}

      - name: 🔐 Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: 📤 Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-app:${{ github.sha }}

      - name: 📤 Upload Gitleaks Report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

      - name: 📤 Upload Trivy FS Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: trivy-fs-results.json

      - name: 📤 Upload Trivy Image Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-results.json

      - name: 📡 Send CI result to Splunk
        run: |
          curl -k https://<your-splunk-server>:8088/services/collector \
          -H "Authorization: Splunk ${{ secrets.SPLUNK_HEC_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"event": "CI pipeline ${{ github.workflow }} on branch ${{ github.ref_name }} (run #${{ github.run_number }}) completed"}'