name: IaC Security Scan

permissions:
  contents: read

on:
  push:
    branches: [main]
    paths:
      - '**/*.tf'
      - '.github/workflows/iac.yml'  # Also trigger on workflow changes
  pull_request:
    branches: [main]
    paths:
      - '**/*.tf'
      - '.github/workflows/iac.yml'

jobs:
  iac-security:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üîí Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          skip_path: .terraform
          output_format: json
          output_file_path: checkov-report.json
          soft_fail: true  # Don't fail the action, we'll handle it
          framework: terraform  # Explicitly set framework

      - name: üì§ Upload Checkov JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.json

      - name: üìä Display Checkov Summary
        if: always()
        run: |
          if [ -f checkov-report.json ]; then
            echo "## Checkov Scan Summary"
            echo "Passed checks: $(jq '.summary.passed' checkov-report.json)"
            echo "Failed checks: $(jq '.summary.failed' checkov-report.json)"
            echo "Skipped checks: $(jq '.summary.skipped' checkov-report.json)"
            
            # Show failed checks details
            if [ $(jq '.summary.failed' checkov-report.json) -gt 0 ]; then
              echo -e "\n### Failed Checks:"
              jq -r '.results.failed_checks[]? | "- [\(.check_id)] \(.check_name): \(.file_path):\(.file_line_range[0])"' checkov-report.json || true
            fi
          fi

      - name: üì° Send Checkov results to Splunk
        if: always()
        env:
          SPLUNK_HEC_URL: ${{ secrets.SPLUNK_HEC_URL }}
          SPLUNK_HEC_TOKEN: ${{ secrets.SPLUNK_HEC_TOKEN }}
        run: |
          if [ -f checkov-report.json ]; then
            CHANNEL_ID=$(uuidgen)
            curl -k "$SPLUNK_HEC_URL" \
              -H "Authorization: Splunk $SPLUNK_HEC_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"event\": $(cat checkov-report.json), \"sourcetype\": \"checkov\", \"channel\": \"$CHANNEL_ID\"}"
          fi

      - name: ‚ùå Fail if Checkov found critical violations
        run: |
          if [ -f checkov-report.json ]; then
            FAILED_COUNT=$(jq '.summary.failed' checkov-report.json)
            if [ "$FAILED_COUNT" -gt 0 ]; then
              echo "‚ùå Checkov found $FAILED_COUNT policy violations"
              exit 1
            else
              echo "‚úÖ All Checkov policies passed!"
            fi
          fi