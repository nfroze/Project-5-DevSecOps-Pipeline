name: IaC Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  iac-security:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v3

      - name: 🔒 Install Checkov
        run: pip install checkov

      - name: 🔍 Run Checkov and generate report (non-blocking)
        run: |
          checkov -d . --skip-path .terraform --output json --output-file-path checkov-report.json || true

      - name: 📤 Upload Checkov report to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.json

      - name: 📡 Send Checkov results to Splunk
        run: |
          RESULTS=$(cat checkov-report.json | jq -c '.')
          CHANNEL_ID=$(uuidgen)
          curl -k https://prd-p-44h4s.splunkcloud.com:8088/services/collector \
            -H "Authorization: Splunk ${{ secrets.SPLUNK_HEC_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "X-Splunk-Request-Channel: $CHANNEL_ID" \
            -d "{\"event\": $RESULTS}"

      - name: ❌ Fail pipeline if Checkov finds issues
        run: |
          if grep -q '"result": "FAILED"' checkov-report.json; then
            echo "❌ Checkov failed policies found — blocking pipeline."
            exit 1
          else
            echo "✅ No Checkov failures — continuing."
          fi