name: IaC Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  iac-security:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ”’ Install Checkov
        run: pip install checkov

      - name: ğŸ” Run Checkov and generate report (non-blocking)
        run: |
          checkov -d . --skip-path .terraform --output json --output-file-path checkov-report.json || true

      - name: ğŸ“¤ Upload Checkov report to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.json

      - name: ğŸ“¡ Send Checkov results to Splunk
        run: |
          RESULTS=$(cat checkov-report.json | jq -c '.')
          CHANNEL_ID=$(uuidgen)
          curl -k https://prd-p-44h4s.splunkcloud.com:8088/services/collector \
            -H "Authorization: Splunk ${{ secrets.SPLUNK_HEC_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "X-Splunk-Request-Channel: $CHANNEL_ID" \
            -d "{\"event\": $RESULTS}"

      - name: âŒ Fail pipeline if Checkov finds issues
        run: |
          if grep -q '"result": "FAILED"' checkov-report.json; then
            echo "âŒ Checkov failed policies found â€” blocking pipeline."
            exit 1
          else
            echo "âœ… No Checkov failures â€” continuing."
          fi